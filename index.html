<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teethlion Microdemo - P2P Chat</title>
    <style>
      body {
        font-family: sans-serif;
        background: #111;
        color: #fff;
        text-align: center;
        padding: 2em;
      }
      textarea {
        width: 80%;
        height: 100px;
        margin-top: 1em;
        background: #222;
        color: #0f0;
        padding: 1em;
        border: none;
      }
      input,
      button {
        padding: 0.5em 1em;
        margin: 0.5em;
      }
      video {
        width: 300px;
        border: 2px solid #333;
        margin: 1em;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "libp2p": "https://esm.sh/libp2p@0.41.4",
          "@libp2p/webrtc": "https://esm.sh/@libp2p/webrtc@5.2.15",
          "@libp2p/websockets": "https://esm.sh/@libp2p/websockets@9.2.13",
          "@libp2p/mplex": "https://esm.sh/@libp2p/mplex@11.0.38",
          "@chainsafe/libp2p-noise": "https://esm.sh/@chainsafe/libp2p-noise@16.1.3",
          "@chainsafe/libp2p-gossipsub": "https://esm.sh/@chainsafe/libp2p-gossipsub@0.15.1",
          "@libp2p/identify": "https://esm.sh/@libp2p/identify@0.18.0"
        }
      }
    </script>
  </head>
  <body>
    <h1>ðŸ§ª Teethlion Microdemo</h1>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <br />
    <input type="text" id="room" placeholder="Room ID (same in all tabs)" />
    <button id="startBtn">Start</button>
    <br />
    <textarea id="chat" readonly></textarea>
    <br />
    <input type="text" id="msg" placeholder="Type message..." />
    <button id="sendBtn">Send</button>

    <script type="module">
      import { createLibp2p } from "https://esm.sh/libp2p@0.41.4";
      import { webRTC } from "https://esm.sh/@libp2p/webrtc@5.2.15";
      import { webSockets } from "https://esm.sh/@libp2p/websockets@9.2.13";
      import { mplex } from "https://esm.sh/@libp2p/mplex@11.0.38";
      import { noise } from "https://esm.sh/@chainsafe/libp2p-noise@16.1.3";
      import { gossipsub } from "https://esm.sh/@chainsafe/libp2p-gossipsub@0.15.1";
      import { identifyService } from "https://esm.sh/@libp2p/identify@0.18.0";

      let node;
      const chat = document.getElementById("chat");
      const sendBtn = document.getElementById("sendBtn");
      const msgInput = document.getElementById("msg");
      const startBtn = document.getElementById("startBtn");
      const roomInput = document.getElementById("room");
      const localVideo = document.getElementById("localVideo");

      async function start() {
        const room = roomInput.value.trim();
        if (!room) return alert("Room required");

        node = await createLibp2p({
          addresses: {
            listen: ["/webrtc"],
          },
          transports: [webRTC(), webSockets()],
          connectionEncryption: [noise()],
          streamMuxers: [mplex()],
          pubsub: gossipsub({ emitSelf: true }),
          services: { identify: identifyService() },
        });

        await node.start();
        console.log("ðŸ”— Node started:", node.peerId.toString());

        await node.services.pubsub.subscribe(room);
        node.services.pubsub.addEventListener("message", (evt) => {
          const str = new TextDecoder().decode(evt.detail.data);
          chat.value += "\nðŸ”µ Peer: " + str;
        });

        navigator.mediaDevices
          .getUserMedia({ video: true, audio: false })
          .then((stream) => {
            localVideo.srcObject = stream;
          })
          .catch(() => {});

        sendBtn.onclick = () => {
          const msg = msgInput.value.trim();
          if (msg && node.services.pubsub) {
            node.services.pubsub.publish(room, new TextEncoder().encode(msg));
            chat.value += "\nðŸŸ¢ You: " + msg;
            msgInput.value = "";
          }
        };
      }

      startBtn.onclick = start;
    </script>
  </body>
</html>
